---
title = "Заметки о метриках бэкенд в 2024"
tags = ["practice", "development", "backend", "feeds-fun"]
published_at = "2024-10-27T12:00:00+00:00"
seo_description = "Некоторые заметки о сборе метри на бэке в 2024 году."
seo_image = ""
---

<!-- TODO: seo image -->

Раз в 2-3 года у меня начинается какой-нибудь новый проект и мне приходится заново разбираться с метриками — как на этот раз их собирать и рисовать. Не то чтобы это единственное, с чем приходится разбираться заново, обычно меняется много всего, но подход к метрикам меняется гарантировано.

Я [слал метрики по UDP]{post:collect-metrics-in-linux} в [Graphite](https://graphiteapp.org/) (в 2024, пост из 2015 выглядит забавно), использовал SaaS-решения вроде [Datadog](https://www.datadoghq.com/) и [New Relic](https://newrelic.com/), аггрегировал метрики в приложении, чтобы их забирал [Prometheus](https://prometheus.io/) и писал метрики в логи для [AWS CloudWatch](https://aws.amazon.com/cloudwatch/).

И всегда были какие-то нюансы.

В метриках пересекается огромное количество областей и интересов:

- Специализированные базы данных для хранения time series.
- Корректность vs достаточность точности vs стоимость поддержки выбранного решения.
- Особенности платформы, на которой разрабатывается проект и его архитектура.
- Идеалогия и личные предпочтения разработчиков.

Поэтому нет одного идеального способа собирать метрики. Более того, разнообразие подходов вкупе с быстрой эволюцией всей области бэкенда привело к появлению огромого количества open-source кирпичей из которых можно собрать любого франкенштейна.

В итоге, когда дошли руки для реализации метрик в [Feeds Fun](https://feeds.fun/) я в очередной раз потратил несколько дней на актуализацию знаний и наведение порядка в голове.

В этом посте я поделюсь некоторыми своими мыслями и решением, которое выбрал для себя. Но не в форме тутуриала, а в форме тезисов с комментариями на темы к которым неравнодушен именно я.

Поскольку я, с большего, бэкендщик, то и рассказывать буду с позиции бэкенда.

<!-- more -->

## Метрики — базовый инструмент для управления технически состоянием проекта на оперативном, тактическом и стратегическом уровнях

Метрики — это буквально глаза разработчика. Без них невозможно видеть как актуальную техническую ситуацию на проекте так и её долгосрочные тренды.

Если брать классический цикл из системной инженерии (и других [мемплексов]{genes-memes-memeplexes}): сбор данных, анализ, синтез (принятие решения), реализация решения, то метрики — это первый шаг цикла (и часть второго). Без них невозможно замкнуть обратную связь для эффективного управления проектом.

Говоря про уровни планирования, метрики помогают:

- На оперативном уровне быстрее разбираться с форс-мажорными ситуациями.
- На тактическом уровне устранять негативные тенденции (вроде деградации производительности из-за роста объёма данных) до момента, когда они срабатывают.
- На стратегическом уровне планировать дорогие изменения в архитектуре и инфраструктуре.

Из этого не слудет, что первым коммитом должна идти реализация метрик — всё хорошо в меру.

При разработке прототипа и даже при начале эксплуатации можно опираться на свой опыт, чуйку, периодические ручные проверки состояния системы, дисциплинированность и компетентность команды. В конце-концов, плохо работающая бизнес-логика без метрик обычно лучше нереализованной бизнес-логики с крутыми метриками :-D

Но общая логика примерно следующая: чем сильнее последствия срабатывания рисков тем больше метрик вам надо.

## За метриками надо следить глазами

Метрики нужны не только для того, чтобы смотреть на них во время борьбы с инцидентами или планирования долгосрочных изменений.

Метрики нужны, чтобы демонстрировать вам динамику проекта, его внутреннюю жизнь.

Обладая привычкой периодически смотреть на метрики глазами, вы запустите [цикл уточнения вашей ментальной модели]{post:life-and-work-with-models} проекта. А точная менатльная модель проекта — это ваше понимания его — залог успешной работы.

## Вы не знаете какие метрики вам потребуются

Есть базовые метрики, которые нужны всем или почти всем. Например, [персентили](https://ru.wikipedia.org/wiki/Процентиль) времени ответа на запросы, количество запросов в секунду, количество ошибок, количество запросов на каждый из эндпоинтов API, размеры базы данных, таблиц, индексов и так далее.

Но базовые метрики, что логично, позволяют реагировать только на базовые проблемы. Это уже много, но каждый проект уникален, более того, уникален путь разработки, поэтому кроме базовых проблем у вас обязательно будут проблемы уникальные для вас. И задачи уникальные для вас.

Для примера, на моём последнем месте работы у нас были реализованы [распределённые транзакции](https://en.wikipedia.org/wiki/Distributed_transaction) для обработки платежей с помощью [Orchestration-based saga](https://microservices.io/patterns/data/saga.html в форме [FSM](https://ru.wikipedia.org/wiki/Конечный_автомат) хранящих своё состояние в базе. В какой-то момент для нас оказалось полезным видеть динамику изменения распределения FSM по состояниям.

Проблема в том, что метрики, в большинстве случаев, при добавлении новой метрики у неё не будет истории. А история изменений — это то, что делает метрики реально полезными. Если вы столкнулись с проблемой и видите её на метриках, то вам важны не только их текущие показатели, но и динамика: направление изменений, цикличность, сезонность и так далее.

Поэтому, разумно следовать следующим эвристикам:

- Много метрик лучше, чем мало.
- Если вам придумалась метрика и добавить её несложно — добавьте.
- Если у вас есть критический компонент в системе, включите режим параноика и облажите его метриками сверху до низу.


ТУДУ:

- заметка про метрики фронта
- туду: алерты
-
