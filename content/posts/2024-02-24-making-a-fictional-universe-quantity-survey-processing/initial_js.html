<!-- TODO: move to brigid config? -->
<!-- TODO: if moved, how to turn on optionally? -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/1.33.1/plotly.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script type="text/javascript">

const redrawPlots = new CustomEvent('redrawPlots', {
    detail: {
        message: "redraw plots",
    }
});

// TODO: translate
const ageGroups = [{id: 'children (0-12)',
                    name: 'Children (0-12)',
                    addToFilter: false,
                    predicate: (row) => row['q_age'] <= 12},
                   {id: 'teens (13-19)',
                    name: 'Teens (13-19)',
                    addToFilter: true,
                    predicate: (row) => row['q_age'] >= 13 && row['q_age'] <= 19},
                   {id: 'young adults (20-29)',
                    name: 'Young adults (20-29)',
                    addToFilter: true,
                    predicate: (row) => row['q_age'] >= 20 && row['q_age'] <= 29},
                   {id: 'adults (30-39)',
                    name: 'Adults (30-39)',
                    addToFilter: true,
                    predicate: (row) => row['q_age'] >= 30 && row['q_age'] <= 39},
                   {id: 'middle-aged adults (40-49)',
                    name: 'Middle-aged adults (40-49)',
                    addToFilter: true,
                    predicate: (row) => row['q_age'] >= 40 && row['q_age'] <= 49},
                   {id: 'older adults (50-59)',
                    name: 'Older adults (50-59)',
                    addToFilter: true,
                    predicate: (row) => row['q_age'] >= 50 && row['q_age'] <= 59},
                   {id: 'seniors (60+)',
                    name: 'Seniors (60+)',
                    addToFilter: false,
                    predicate: (row) => row['q_age'] >= 60},
                   {id: 'N/A',
                    name: 'N/A',
                    addToFilter: false,
                    predicate: (row) => row['q_age'] == null}];

const ageGroupIds = ageGroups.map(function(group) {
    return group.id;
});
ageGroupIds.push('N/A');

const strategyGamesGroups = [{id: '4x',
                              name: '4X',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#4x'] == 1},
                             {id: 'city_builders',
                              name: 'City builders',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#city_builders'] == 1},
                             {id: 'decision_driven',
                              name: 'Decision driven',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#decision_driven'] == 1},
                             {id: 'grand_strategies',
                              name: 'Grand strategies',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#grand_strategies'] == 1},
                             {id: 'roguelike',
                              name: 'Roguelike',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#roguelike'] == 1},
                             {id: 'rts',
                              name: 'RTS',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#rts'] == 1},
                             {id: 'tactics',
                              name: 'Tactics',
                              addToFilter: false,
                              predicate: (row) => row['q_strategy_games_like#tactics'] == 1},
                             {id: 'tycoon',
                              name: 'Tycoon',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#tycoon'] == 1}];

function filterAll(row) {
    return true;
}

function filterGameDevelopers(row) {
    return row['q_is_game_developer'] === 'yes';
}

function filterPlayers(row) {
    return row['q_is_game_developer'] === 'no';
}

const filters = {
    'all': {
        name: 'All',
        filter: (row) => true
    },
    'gameDevelopers': {
        name: 'Game developers',
        filter: (row) => row['q_is_game_developer'] === 'yes'
    },
    'players': {
        name: 'Players',
        filter: (row) => row['q_is_game_developer'] === 'no'
    },
    'occupationEmployment': {
        name: 'Occupation: Employment',
        filter: (row) => row['q_occupation'] === 'employment'
    },
    'occupationStudent': {
        name: 'Occupation: Student',
        filter: (row) => row['q_occupation'] === 'student'
    },
    'occupationOther': {
        name: 'Occupation: Other',
        filter: (row) => !['employment', 'student'].includes(row['q_occupation'])
    },
    'playingStrategiesAlot': {
        name: 'Playing strategies: a lot',
        filter: (row) => row['q_play_strategy_games'] >= 8
    },
    'playingStrategiesSometimes': {
        name: 'Playing strategies: sometimes',
        filter: (row) => row['q_play_strategy_games'] >= 5 && row['q_play_strategy_games'] <= 7
    },
    'playingStrategiesNo': {
        name: 'Playing strategies: no',
        filter: (row) => row['q_play_strategy_games'] <= 4
    },
};

for (let ageId in ageGroups) {
    let ageGroup = ageGroups[ageId];
    if (!ageGroup.addToFilter) {
        continue;
    }
    filters[ageGroup.id] = {name: 'Age: ' + ageGroup.name,
                            filter: ageGroup.predicate};
}

for (let strategyGameId in strategyGamesGroups) {
    let strategyGameGroup = strategyGamesGroups[strategyGameId];
    if (!strategyGameGroup.addToFilter) {
        continue;
    }
    filters[strategyGameGroup.id] = {name: 'Games: ' + strategyGameGroup.name,
                                     filter: strategyGameGroup.predicate};
}

var fullData = null;

var filterA = 'all';
var filterB = 'adults (30-39)';

// TODO: do something with the file path
// TODO: move to the bottom of the page?
Papa.parse("/static/posts/making-a-fictional-universe-quantity-survey-processing/2024_02_23_cleaned_data.csv", {
    download: true,
    header: true,
    dynamicTyping: true,
    skipEmptyLines: true,
    complete: function(results) {
        fullData = results.data;
        document.dispatchEvent(redrawPlots);
    }
});


function groupMapper(groups) {
    return function(row) {
        const resultGroups = [];

        for (let groupIndex in groups) {
            const group = groups[groupIndex];

            if (group.predicate(row)) {
                resultGroups.push(group.id);
            }
        }

        return resultGroups;
    };
}

function groupIds(groups) {
    return groups.map(function(group) {
        return group.id;
    });
}

function getPlotData(data, filter, map, uniqueValues) {
    var filteredData = data.filter(filter);
    var mappedData = filteredData.map(map);

    // if mappedData contains multiple groups per row, flatten it
    if (mappedData[0] instanceof Array) {
        mappedData = mappedData.flat();
    }

    // print error if mappedData contains item not from uniqueValues
    mappedData.forEach(function(value) {
        if (!uniqueValues.includes(value)) {
            console.error('Value ' + value + ' not in uniqueValues');
        }
    });

    const counts = uniqueValues.map(function(value) {
        return mappedData.filter(function(x) {
            return x === value;
        }).length;
    });


    const percents = counts.map(function(count) {
        return (count / filteredData.length * 100).toFixed(2);
    });

    return {
        values: uniqueValues,
        counts: counts,
        percents: percents
    };
}

// TODO: remove unnecessary buttons from plotly plot
function barPlot(selector, map, barsOrder) {

    document.addEventListener('redrawPlots', (e) => {

        if (fullData === null) {
            return;
        }

        if (!(filterA in filters)) {
            console.error('Unknown filterA:', filterA);
            return;
        }

        if (!(filterB in filters)) {
            console.error('Unknown filterB:', filterA);
            return;
        }

        const dataA = getPlotData(fullData, filters[filterA].filter, map, barsOrder);
        const dataB = getPlotData(fullData, filters[filterB].filter, map, barsOrder);

        function toText(percents, counts) {
            return percents.map((x, i) => x.toString() + '% count: ' + counts[i].toString());
        }

        data = [{
            'x': dataA.values,
            'y': dataA.percents,
            'text': toText(dataA.percents, dataA.counts),
            'hoverinfo': 'text',
            'name': filters[filterA].name,
            'type': 'bar'
        },{
            'x': dataB.values,
            'y': dataB.percents,
            'text': toText(dataB.percents, dataB.counts),
            'hoverinfo': 'text',
            'name': filters[filterB].name,
            'type': 'bar'
        }];

        var layout = {
            barmode: 'group',
            xaxis: {
                dtick: 1
            },
            yaxis: {
                title: 'percent'
            }
        };

        Plotly.newPlot(selector, data, layout);
    });
}

</script>
