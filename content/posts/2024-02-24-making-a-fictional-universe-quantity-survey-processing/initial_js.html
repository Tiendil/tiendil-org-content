<!-- TODO: move to brigid config? -->
<!-- TODO: if moved, how to turn on optionally? -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/1.33.1/plotly.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script type="text/javascript">

const redrawPlots = new CustomEvent('redrawPlots', {
    detail: {
        message: "redraw plots",
    }
});

// TODO: translate
const ageGroups = [{id: 'children (0-12)',
                    name: 'Children (0-12)',
                    addToFilter: false,
                    predicate: (row) => row['q_age'] <= 12},
                   {id: 'teens (13-19)',
                    name: 'Teens (13-19)',
                    addToFilter: true,
                    predicate: (row) => row['q_age'] >= 13 && row['q_age'] <= 19},
                   {id: 'young adults (20-29)',
                    name: 'Young adults (20-29)',
                    addToFilter: true,
                    predicate: (row) => row['q_age'] >= 20 && row['q_age'] <= 29},
                   {id: 'adults (30-39)',
                    name: 'Adults (30-39)',
                    addToFilter: true,
                    predicate: (row) => row['q_age'] >= 30 && row['q_age'] <= 39},
                   {id: 'middle-aged adults (40-49)',
                    name: 'Middle-aged adults (40-49)',
                    addToFilter: true,
                    predicate: (row) => row['q_age'] >= 40 && row['q_age'] <= 49},
                   {id: 'older adults (50-59)',
                    name: 'Older adults (50-59)',
                    addToFilter: true,
                    predicate: (row) => row['q_age'] >= 50 && row['q_age'] <= 59},
                   {id: 'seniors (60+)',
                    name: 'Seniors (60+)',
                    addToFilter: false,
                    predicate: (row) => row['q_age'] >= 60},
                   {id: 'N/A',
                    name: 'N/A',
                    addToFilter: false,
                    predicate: (row) => row['q_age'] == null}];

const strategyGamesGroups = [{id: '4x',
                              name: '4X',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#4x'] == 1},
                             {id: 'city_builders',
                              name: 'City builders',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#city_builders'] == 1},
                             {id: 'decision_driven',
                              name: 'Decision driven',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#decision_driven'] == 1},
                             {id: 'grand_strategies',
                              name: 'Grand strategies',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#grand_strategies'] == 1},
                             {id: 'roguelike',
                              name: 'Roguelike',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#roguelike'] == 1},
                             {id: 'rts',
                              name: 'RTS',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#rts'] == 1},
                             {id: 'tactics',
                              name: 'Tactics',
                              addToFilter: false,
                              predicate: (row) => row['q_strategy_games_like#tactics'] == 1},
                             {id: 'tycoon',
                              name: 'Tycoon',
                              addToFilter: true,
                              predicate: (row) => row['q_strategy_games_like#tycoon'] == 1}];

const knowAboutGamesGroups = [{id: 'advertising',
                               name: 'Advertising',
                               addToFilter: false,
                               predicate: (row) => row['q_know_about_new_games#advertising'] == 1},
                              {id: 'coworkers',
                               name: 'Coworkers',
                               addToFilter: false,
                               predicate: (row) => row['q_know_about_new_games#coworkers'] == 1},
                              {id: 'do_not_search',
                               name: 'Do not search',
                               addToFilter: false,
                               predicate: (row) => row['q_know_about_new_games#do_not_search'] == 1},
                              {id: 'free_search',
                               name: 'Free search',
                               addToFilter: false,
                               predicate: (row) => row['q_know_about_new_games#free_search'] == 1},
                              {id: 'friends',
                               name: 'Friends',
                               addToFilter: false,
                               predicate: (row) => row['q_know_about_new_games#friends'] == 1},
                              {id: 'game_stores',
                               name: 'Game stores',
                               addToFilter: false,
                               predicate: (row) => row['q_know_about_new_games#game_stores'] == 1},
                              {id: 'personalized_news',
                               name: 'Personalized news',
                               addToFilter: false,
                               predicate: (row) => row['q_know_about_new_games#personalized_news'] == 1},
                              {id: 'social_networks',
                               name: 'Social networks',
                               addToFilter: false,
                               predicate: (row) => row['q_know_about_new_games#social_networks'] == 1},
                              {id: 'specialized_sites',
                               name: 'Specialized sites',
                               addToFilter: false,
                               predicate: (row) => row['q_know_about_new_games#specialized_sites'] == 1},
                              {id: 'video_services',
                               name: 'Video services',
                               addToFilter: false,
                               predicate: (row) => row['q_know_about_new_games#video_services'] == 1}];

const likeInGamesGroups = [{id: 'achievements',
                            name: 'Achievements',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#achievements'] == 1},
                           {id: 'changing_game_world',
                            name: 'Changing game world',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#changing_game_world'] == 1},
                           {id: 'collecting',
                            name: 'Collecting',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#collecting'] == 1},
                           {id: 'creating_strategies',
                            name: 'Creating strategies',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#creating_strategies'] == 1},
                           {id: 'customizing',
                            name: 'Customizing',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#customizing'] == 1},
                           {id: 'exploring',
                            name: 'Exploring',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#exploring'] == 1},
                           {id: 'looting',
                            name: 'Looting',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#looting'] == 1},
                           {id: 'messing_with_game_rules',
                            name: 'Messing with game rules',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#messing_with_game_rules'] == 1},
                           {id: 'overcoming_challenges',
                            name: 'Overcoming challenges',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#overcoming_challenges'] == 1},
                           {id: 'risking',
                            name: 'Risking',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#risking'] == 1},
                           {id: 'roleplaying',
                            name: 'Roleplaying',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#roleplaying'] == 1},
                           {id: 'solving_puzzles',
                            name: 'Solving puzzles',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#solving_puzzles'] == 1},
                           {id: 'story',
                            name: 'Story',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#story'] == 1},
                           {id: 'what_if_scenarious',
                            name: 'What if scenarious',
                            addToFilter: true,
                            predicate: (row) => row['q_like_in_games#what_if_scenarious'] == 1}];

const newsChannelsTypes = [{id: 'augmented_reality',
                            name: 'Augmented reality',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#augmented_reality'] == 1},
                           {id: 'chats',
                            name: 'Chats',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#chats'] == 1},
                           {id: 'magic_creatures',
                            name: 'Magic creatures',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#magic_creatures'] == 1},
                           {id: 'magic_devices',
                            name: 'Magic devices',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#magic_devices'] == 1},
                           {id: 'mobile_application',
                            name: 'Mobile application',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#mobile_application'] == 1},
                           {id: 'neural_implants',
                            name: 'Neural implants',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#neural_implants'] == 1},
                           {id: 'news_in_vr',
                            name: 'News in VR',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#news_in_vr'] == 1},
                           {id: 'online_radio',
                            name: 'Online radio',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#online_radio'] == 1},
                           {id: 'social_networks',
                            name: 'Social networks',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#social_networks'] == 1},
                           {id: 'traditional_newspaper',
                            name: 'Traditional newspaper',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#traditional_newspaper'] == 1},
                           {id: 'traditional_radio',
                            name: 'Traditional radio',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#traditional_radio'] == 1},
                           {id: 'traditional_tv',
                            name: 'Traditional TV',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#traditional_tv'] == 1},
                           {id: 'web_portal',
                            name: 'Web portal',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#web_portal'] == 1},
                           {id: 'youtube',
                            name: 'Youtube',
                            addToFilter: true,
                            predicate: (row) => row['q_channels#youtube'] == 1}];


const filters = {
    'all': {
        name: 'All',
        filter: (row) => true
    },
    'gameDevelopers': {
        name: 'Game developers',
        filter: (row) => row['q_is_game_developer'] === 'yes'
    },
    'players': {
        name: 'Players',
        filter: (row) => row['q_is_game_developer'] === 'no'
    },
    'occupationEmployment': {
        name: 'Occupation: Employment',
        filter: (row) => row['q_occupation'] === 'employment'
    },
    'occupationStudent': {
        name: 'Occupation: Student',
        filter: (row) => row['q_occupation'] === 'student'
    },
    'occupationOther': {
        name: 'Occupation: Other',
        filter: (row) => !['employment', 'student'].includes(row['q_occupation'])
    },
    'playingStrategiesAlot': {
        name: 'Playing strategies: a lot',
        filter: (row) => row['q_play_strategy_games'] >= 8
    },
    'playingStrategiesSometimes': {
        name: 'Playing strategies: sometimes',
        filter: (row) => row['q_play_strategy_games'] >= 5 && row['q_play_strategy_games'] <= 7
    },
    'playingStrategiesNo': {
        name: 'Playing strategies: no',
        filter: (row) => row['q_play_strategy_games'] <= 4
    },
    'effortInGamesAlot': {
        name: 'Effort in games: a lot',
        filter: (row) => row['q_playing_effort'] >= 8
    },
    'effortInGamesSome': {
        name: 'Effort in games: some',
        filter: (row) => row['q_playing_effort'] >= 5 && row['q_playing_effort'] <= 7
    },
    'effortInGamesNo': {
        name: 'Effort in games: no',
        filter: (row) => row['q_playing_effort'] <= 4
    },
    'likeRPGElementsAlot': {
        name: 'Like RPG elements: a lot',
        filter: (row) => row['q_rpg_elements'] >= 8
    },
    'likeRPGElementsSome': {
        name: 'Like RPG elements: some',
        filter: (row) => row['q_rpg_elements'] >= 5 && row['q_rpg_elements'] <= 7
    },
    'likeRPGElementsNo': {
        name: 'Like RPG elements: no',
        filter: (row) => row['q_rpg_elements'] <= 4
    },
    'multipleChannelsImportant': {
        name: 'Multiple channels: important',
        filter: (row) => row['q_multiple_channels_esential'] >= 8
    },
    'multipleChannelsWillBeGood': {
        name: 'Multiple channels: will be good',
        filter: (row) => row['q_multiple_channels_esential'] >= 5 && row['q_multiple_channels_esential'] <= 7
    },
    'multipleChannelsNotImportant': {
        name: 'Multiple channels: not important',
        filter: (row) => row['q_multiple_channels_esential'] <= 4
    },
    'journalismRealimsFull': {
        name: 'Journalism realism: full',
        filter: (row) => row['q_realistic_work'] >= 8
    },
    'journalismRealismPartial': {
        name: 'Journalism realism: partial',
        filter: (row) => row['q_realistic_work'] >= 5 && row['q_realistic_work'] <= 7
    },
    'journalismRealismNotImportant': {
        name: 'Journalism realism: not important',
        filter: (row) => row['q_realistic_work'] <= 4
    },
    'competitorsFew': {
        name: 'Competitors: few',
        filter: (row) => row['q_concurrent_agencies'] == 'few'
    },
    'competitorsAlot': {
        name: 'Competitors: a lot',
        filter: (row) => row['q_concurrent_agencies'] == 'the_more_the_better'
    },
    'agencySizeRelativlySmall': {
        name: 'Agency size: relativly small — <= 50',
        filter: (row) => ['up_to_10', 'up_to_25', 'up_to_50', 'small_or_automanage'].includes(row['q_max_agency_size'])
    },
    'agencySizeRelativlyBig': {
        name: 'Agency size: relativly big — > 50',
        filter: (row) => ['up_to_100', 'bureaucratic_empire', 'small_or_automanage'].includes(row['q_max_agency_size'])
    },
    'budgetEffortAlot': {
        name: 'Budget effort: a lot',
        filter: (row) => row['q_budget_effort'] >= 8
    },
    'budgetEffortSome': {
        name: 'Budget effort: some',
        filter: (row) => row['q_budget_effort'] >= 5 && row['q_budget_effort'] <= 7
    },
    'budgetEffortNo': {
        name: 'Budget effort: no',
        filter: (row) => row['q_budget_effort'] <= 4
    },
    'relationshipsEffortAlot': {
        name: 'Relationships effort: a lot',
        filter: (row) => row['q_relationships_effort'] >= 8
    },
    'relationshipsEffortSome': {
        name: 'Relationships effort: some',
        filter: (row) => row['q_relationships_effort'] >= 5 && row['q_relationships_effort'] <= 7
    },
    'relationshipsEffortNo': {
        name: 'Relationships effort: no',
        filter: (row) => row['q_relationships_effort'] <= 4
    },
};

for (let ageId in ageGroups) {
    let ageGroup = ageGroups[ageId];
    if (!ageGroup.addToFilter) {
        continue;
    }
    filters[ageGroup.id] = {name: 'Age: ' + ageGroup.name,
                            filter: ageGroup.predicate};
}

for (let strategyGameId in strategyGamesGroups) {
    let strategyGameGroup = strategyGamesGroups[strategyGameId];
    if (!strategyGameGroup.addToFilter) {
        continue;
    }
    filters[strategyGameGroup.id] = {name: 'Games: ' + strategyGameGroup.name,
                                     filter: strategyGameGroup.predicate};
}

for (let likeInGamesId in likeInGamesGroups) {
    let likeInGamesGroup = likeInGamesGroups[likeInGamesId];
    if (!likeInGamesGroup.addToFilter) {
        continue;
    }
    filters[likeInGamesGroup.id] = {name: 'Like: ' + likeInGamesGroup.name,
                                    filter: likeInGamesGroup.predicate};
}

for (let newsChannelsTypeId in newsChannelsTypes) {
    let newsChannelsType = newsChannelsTypes[newsChannelsTypeId];
    if (!newsChannelsType.addToFilter) {
        continue;
    }
    filters[newsChannelsType.id] = {name: 'News: ' + newsChannelsType.name,
                                    filter: newsChannelsType.predicate};
}

var fullData = null;

var filterA = 'all';
var filterB = 'adults (30-39)';

// TODO: do something with the file path
// TODO: move to the bottom of the page?
Papa.parse("/static/posts/making-a-fictional-universe-quantity-survey-processing/2024_02_23_cleaned_data.csv", {
    download: true,
    header: true,
    dynamicTyping: true,
    skipEmptyLines: true,
    complete: function(results) {
        fullData = results.data;
        document.dispatchEvent(redrawPlots);
    }
});


function groupMapper(groups) {
    return function(row) {
        const resultGroups = [];

        for (let groupIndex in groups) {
            const group = groups[groupIndex];

            if (group.predicate(row)) {
                resultGroups.push(group.id);
            }
        }

        return resultGroups;
    };
}

function groupIds(groups) {
    return groups.map(function(group) {
        return group.id;
    });
}

function getPlotData(data, filter, map, uniqueValues) {
    var filteredData = data.filter(filter);
    var mappedData = filteredData.map(map);

    // if mappedData contains multiple groups per row, flatten it
    if (mappedData[0] instanceof Array) {
        mappedData = mappedData.flat();
    }

    // print error if mappedData contains item not from uniqueValues
    mappedData.forEach(function(value) {
        if (!uniqueValues.includes(value)) {
            console.error('Value ' + value + ' not in uniqueValues');
        }
    });

    const counts = uniqueValues.map(function(value) {
        return mappedData.filter(function(x) {
            return x === value;
        }).length;
    });


    const percents = counts.map(function(count) {
        return (count / filteredData.length * 100).toFixed(2);
    });

    return {
        values: uniqueValues,
        counts: counts,
        percents: percents
    };
}

// TODO: remove unnecessary buttons from plotly plot
function barPlot(selector, map, barsOrder) {

    document.addEventListener('redrawPlots', (e) => {

        if (fullData === null) {
            return;
        }

        if (!(filterA in filters)) {
            console.error('Unknown filterA:', filterA);
            return;
        }

        if (!(filterB in filters)) {
            console.error('Unknown filterB:', filterA);
            return;
        }

        const dataA = getPlotData(fullData, filters[filterA].filter, map, barsOrder);
        const dataB = getPlotData(fullData, filters[filterB].filter, map, barsOrder);

        function toText(percents, counts) {
            return percents.map((x, i) => x.toString() + '% count: ' + counts[i].toString());
        }

        data = [{
            'x': dataA.values,
            'y': dataA.percents,
            'text': toText(dataA.percents, dataA.counts),
            'hoverinfo': 'text',
            'name': filters[filterA].name,
            'type': 'bar'
        },{
            'x': dataB.values,
            'y': dataB.percents,
            'text': toText(dataB.percents, dataB.counts),
            'hoverinfo': 'text',
            'name': filters[filterB].name,
            'type': 'bar'
        }];

        var layout = {
            barmode: 'group',
            xaxis: {
                dtick: 1
            },
            yaxis: {
                title: 'percent'
            },
            legend: {
                orientation: 'h',
                x: 0.5, // Centers the legend horizontally
                xanchor: 'center', // Uses the center of the legend as the anchor point
                y: 1.1, // Positions the legend above the chart
                yanchor: 'bottom' // Uses the bottom of the legend to position it relative to the chart
            }
        };

        Plotly.newPlot(selector, data, layout);
    });
}

</script>
