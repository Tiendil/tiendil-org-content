<!-- TODO: move to brigid config? -->
<!-- TODO: if moved, how to turn on optionally? -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/1.33.1/plotly.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script type="text/javascript">

const redrawPlots = new CustomEvent('redrawPlots', {
    detail: {
        message: "redraw plots",
    }
});

// TODO: translate
const ageGroups = [{id: 'children (0-12)',
                    name: 'Children (0-12)',
                    addToFilter: false,
                    min: 0,
                    max: 12},
                   {id: 'teens (13-19)',
                    name: 'Teens (13-19)',
                    addToFilter: true,
                    min: 13,
                    max: 19},
                   {id: 'young adults (20-29)',
                    name: 'Young adults (20-29)',
                    addToFilter: true,
                    min: 20,
                    max: 29},
                   {id: 'adults (30-39)',
                    name: 'Adults (30-39)',
                    addToFilter: true,
                    min: 30,
                    max: 39},
                   {id: 'middle-aged adults (40-49)',
                    name: 'Middle-aged adults (40-49)',
                    addToFilter: true,
                    min: 40,
                    max: 49},
                   {id: 'older adults (50-59)',
                    name: 'Older adults (50-59)',
                    addToFilter: true,
                    min: 50,
                    max: 59},
                   {id: 'seniors (60+)',
                    name: 'Seniors (60+)',
                    addToFilter: false,
                    min: 60,
                    max: 100500}];

const ageGroupIds = ageGroups.map(function(group) {
    return group.id;
});
ageGroupIds.push('N/A');

function filterAll(row) {
    return true;
}

function filterGameDevelopers(row) {
    return row['q_is_game_developer'] === 'yes';
}

function filterPlayers(row) {
    return row['q_is_game_developer'] === 'no';
}

function mapAge(row) {

    if (row['q_age'] == null) {
        return 'N/A';
    }

    for (let ageId in ageGroups) {
        let ageGroup = ageGroups[ageId];

        if (ageGroup.min <= row['q_age'] && row['q_age'] <= ageGroup.max) {
            return ageGroup.id;
        }
    }

    console.log('Unknown age:', row['q_age']);
}

function _constructAgeGroupFilter(groupId) {
    return function(row) {
        if (mapAge(row) == groupId) {
            return true;
        }
        return false;
    };
}

const filters = {
    'all': {
        name: 'All',
        filter: (row) => true
    },
    'gameDevelopers': {
        name: 'Game developers',
        filter: (row) => row['q_is_game_developer'] === 'yes'
    },
    'players': {
        name: 'Players',
        filter: (row) => row['q_is_game_developer'] === 'no'
    },
    'occupation_employment': {
        name: 'Occupation: Employment',
        filter: (row) => row['q_occupation'] === 'employment'
    },
    'occupation_student': {
        name: 'Occupation: Student',
        filter: (row) => row['q_occupation'] === 'student'
    },
    'occupation_other': {
        name: 'Occupation: Other',
        filter: (row) => !['employment', 'student'].includes(row['q_occupation'])
    },
};

for (let ageId in ageGroups) {
    let ageGroup = ageGroups[ageId];
    if (!ageGroup.addToFilter) {
        continue;
    }
    filters[ageGroup.id] = {name: 'Age: ' + ageGroup.name, filter: _constructAgeGroupFilter(ageGroup.id)};
}

var fullData = null;

var filterA = 'all';
var filterB = 'adults (30-39)';

// TODO: do something with the file path
// TODO: move to the bottom of the page?
Papa.parse("/static/posts/making-a-fictional-universe-quantity-survey-processing/2024_02_23_cleaned_data.csv", {
    download: true,
    header: true,
    dynamicTyping: true,
    skipEmptyLines: true,
    complete: function(results) {
        fullData = results.data;
        document.dispatchEvent(redrawPlots);
    }
});

function getPlotData(data, filter, map, uniqueValues) {
    var filteredData = data.filter(filter);
    var mappedData = filteredData.map(map);

    // if mappedData contains multiple groups per row, flatten it
    if (mappedData[0] instanceof Array) {
        mappedData = mappedData.flat();
    }

    // print error if mappedData contains item not from uniqueValues
    mappedData.forEach(function(value) {
        if (!uniqueValues.includes(value)) {
            console.error('Value ' + value + ' not in uniqueValues');
        }
    });

    const counts = uniqueValues.map(function(value) {
        return mappedData.filter(function(x) {
            return x === value;
        }).length;
    });


    const percents = counts.map(function(count) {
        return (count / filteredData.length * 100).toFixed(2);
    });

    return {
        values: uniqueValues,
        counts: counts,
        percents: percents
    };
}

// TODO: remove unnecessary buttons from plotly plot
function barPlot(selector, map, barsOrder) {

    document.addEventListener('redrawPlots', (e) => {

        if (fullData === null) {
            return;
        }

        if (!(filterA in filters)) {
            console.error('Unknown filterA:', filterA);
            return;
        }

        if (!(filterB in filters)) {
            console.error('Unknown filterB:', filterA);
            return;
        }

        const dataA = getPlotData(fullData, filters[filterA].filter, map, barsOrder);
        const dataB = getPlotData(fullData, filters[filterB].filter, map, barsOrder);

        function toText(percents, counts) {
            return percents.map((x, i) => x.toString() + '% count: ' + counts[i].toString());
        }

        data = [{
            'x': dataA.values,
            'y': dataA.percents,
            'text': toText(dataA.percents, dataA.counts),
            'hoverinfo': 'text',
            'name': filters[filterA].name,
            'type': 'bar'
        },{
            'x': dataB.values,
            'y': dataB.percents,
            'text': toText(dataB.percents, dataB.counts),
            'hoverinfo': 'text',
            'name': filters[filterB].name,
            'type': 'bar'
        }];

        var layout = {
            barmode: 'group',
            xaxis: {
            },
            yaxis: {
                title: 'percent'
            }
        };

        Plotly.newPlot(selector, data, layout);
    });
}

</script>
