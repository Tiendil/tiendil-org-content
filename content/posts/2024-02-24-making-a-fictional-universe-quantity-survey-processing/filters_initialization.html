<script type="text/javascript">

 // parse raw data into objects
 headers = rawData[0];
 fullData = [];

 for (let i = 1; i < rawData.length; i++) {
   let row = rawData[i];
   let obj = {};

   for (let j = 0; j < headers.length; j++) {
     obj[headers[j]] = row[j];
   }

   fullData.push(obj);
 }

 // enrich data

 fullData.forEach(row => {
   const metaGroups = {m_hard: 0,
                       m_core: 0,
                       m_casual: 0};

   for (let filterKey in filters) {
     const filter = filters[filterKey];

     if ('metaGroupPoints' in filter && filter.filter(row)) {
       for (groupKey in filter.metaGroupPoints) {
         if (!(groupKey in metaGroups)) {
           console.log('Unknown group key: ' + groupKey);
         }

         metaGroups[groupKey] += filter.metaGroupPoints[groupKey];
       }
     }

     if (metaGroups.m_core >= metaGroups.m_hard && metaGroups.m_core >= metaGroups.m_casual) {
       row['m_effort'] = 'core';
     } else if (metaGroups.m_casual >= metaGroups.m_hard && metaGroups.m_casual > metaGroups.m_core) {
       row['m_effort'] = 'casual';
     } else if (metaGroups.m_hard > metaGroups.m_core && metaGroups.m_hard > metaGroups.m_casual) {
       row['m_effort'] = 'hard';
     } else {
       console.error('Unknown meta effort group');
     }

     for (let groupKey in metaGroups) {
       row[groupKey] = metaGroups[groupKey];
     }
   }

 });

 // fill filters

 function applyFilters() {
   for (var key in filters) {
     filters[key].values = fullData.filter(filters[key].filter);
   }
 }

 applyFilters();

 function fillFilters() {
   var index = 0;

   var selects = document.querySelectorAll('.plot-filter');

   for (var select of selects) {

     // set id for select
     select.id = 'plot-filter-' + index;
     index++;

     for (var key in filters) {
       var option = document.createElement('option');
       option.value = key;
       option.text = `${filters[key].name} [size: ${filters[key].values.length}]`;
       select.appendChild(option);
     }
   }
 }

 fillFilters();

 function selectFilterA(value, skipEvent) {
   filterA = value;
   var selects = document.querySelectorAll('.plot-filter-a');

   for (var select of selects) {
     select.value = filterA;
   }

   if (skipEvent != 'skip-event') {
     document.dispatchEvent(redrawPlots);
   }
 }

 function selectFilterB(value, skipEvent) {
   filterB = value;
   var selects = document.querySelectorAll('.plot-filter-b');

   for (var select of selects) {
     select.value = filterB;
   }

   if (skipEvent != 'skip-event') {
     document.dispatchEvent(redrawPlots);
   }
 }

 function collectQuestionsVariants() {
   const questions = {};

   const rowExample = fullData[0];

   for (let key in rowExample) {
     if (key.includes('#')) {
       const parts = key.split('#');

       if (!(parts[0] in questions)) {
         questions[parts[0]] = {type: 'multichoice',
                                values: []};
       }

       if (!questions[parts[0]].values.includes(parts[1])) {
         questions[parts[0]].values.push(parts[1])
       }
       continue;
     }

     if (key == 'q_age') {
       const values = [];

       ageGroups.forEach(group => {
         values.push(group.id);
       });

       questions[key] = {type: 'age',
                         values: values};
       continue;
     }

     if (key == '') {
       continue;
     }

     if (key == null) {
       continue;
     }

     if (key == 'null') {
       continue;
     }

     if (['q_gender', 'q_occupation', 'q_is_game_developer', 'q_concurrent_agencies', 'q_max_agency_size'].includes(key)) {

       const values = [];

       fullData.forEach(row => {
         if (!values.includes(row[key])) {
           values.push(row[key]);
         }
       });

       questions[key] = {type: 'category',
                         values: values};
       continue;
     }

     questions[key] = {type: 'numeric',
                       values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]};
   }

   return questions;
 }

 const heatmapQuestions = collectQuestionsVariants();

 function fillHeatmapFilters() {
   var index = 0;

   var selects = document.querySelectorAll('.plot-heatmap-filter');

   for (var select of selects) {

     select.id = 'plot-heatmap-filter-' + index;
     index++;

     for (var key in heatmapQuestions) {
       var option = document.createElement('option');
       option.value = key;
       option.text = key;  // TODO
       select.appendChild(option);
     }
   }
 }

 fillHeatmapFilters();

 function selectHeatmapFilterA(value, skipEvent) {
   heatmapFilterA = value;
   var selects = document.querySelectorAll('.plot-heatmap-filter-a');

   for (var select of selects) {
     select.value = heatmapFilterA;
   }

   if (skipEvent != 'skip-event') {
     document.dispatchEvent(redrawPlots);
   }
 }

 function selectHeatmapFilterB(value, skipEvent) {
   heatmapFilterB = value;
   var selects = document.querySelectorAll('.plot-heatmap-filter-b');

   for (var select of selects) {
     select.value = heatmapFilterB;
   }

   if (skipEvent != 'skip-event') {
     document.dispatchEvent(redrawPlots);
   }
 }

 selectFilterA(filterA, 'skip-event');
 selectFilterB(filterB, 'skip-event');
 selectHeatmapFilterA(heatmapFilterA, 'skip-event');
 selectHeatmapFilterB(heatmapFilterB, 'skip-event');

 document.dispatchEvent(redrawPlots);

</script>
